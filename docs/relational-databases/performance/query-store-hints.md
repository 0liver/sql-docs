---
title: "Query Store Hints (Preview)"
description: Learn about the SQL Server Hints feature to shape query plans without changing application code.
ms.custom: ""
ms.date: "1/7/2021"
ms.prod: sql
ms.prod_service: "database-engine, sql-database"
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords: 
  - "Query Store"
dev_langs:
 - "TSQL"
author: WilliamDAssafMSFT
ms.author: wiassaf
monikerRange: "=azuresqldb-current||>=sql-server-2016||= azure-sqldw-latest||>=sql-server-linux-2017||=azuresqldb-mi-current"
---
# Query Store Hints (Preview)
[!INCLUDE [asdb](../../includes/applies-to-version/asdb.md)]

This article outlines the Query Store Hints feature of the [Query Store](monitoring-performance-by-using-the-query-store.md).

## Overview

Ideally the Query Optimizer selects an optimal execution plan for a query. When this doesn't happen, a developer or DBA may wish to manually optimize for specific conditions. Query hints are specified via the OPTION clause and can be used to affect behavior of operators in a statement. While query hints help provide localized solutions to various performance-related issues, they do require a rewrite of the original query text. Database administrators and developers may not always be able to make changes directly to T-SQL code to inject a query hint. The T-SQL may be hard-coded into an application or automatically generated by the application. Previously, a developer may have to rely on plan guides, which can be complex to use.

The Query Store Hints feature provides an easy-to-use method for shaping query plans without changing application code. This public preview feature is available in Azure SQL Database â€“ including in Azure SQL single databases, elastic pools, managed instances, and Hyperscale databases.  

## When to use Query Store Hints

As the name suggests, this feature extends and depends on [Query Store](monitoring-performance-by-using-the-query-store.md). Query Store enables the capturing of queries, execution plans, and associated runtime statistics. Introduced in SQL Server 2016 and on-by-default in Azure SQL Database, Query Store greatly simplifies the overall performance tuning customer experience.  

Examples where Query Store Hints can help with query-level performance issues:
*    Recompile a query on each execution.
*    Cap the memory grant size for a bulk insert operation.
*    Limit the maximum degree of parallelism for a statistics update operation.
*    Use a hash join instead of a loop join.
*    Use compatibility level 110 for a specific query while keeping everything else in the database at compatibility level 150.
*    Disable optimizer row goal for a SELECT TOP query.

To use Query Store Hints, do the following:
1.    Identify the Query Store query_id of the query statement you wish to modify. You can do this various ways: 
    1. Querying the [Query Store catalog views](../system-catalog-views/query-store-catalog-views-transact-sql.md).
    1. Using SQL Server Management Studio built-in Query Store reports.
    1. Using Azure portal Query Performance Insight for Azure SQL Database.
1.    Execute sp_query_store_set_hints with the query_id and query hint string you wish to apply to the query.  This string can contain one or more query hints. For complete information, see [sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md).

Once created, Query Store Hints are persisted and survive restarts and failovers.  Query Store Hints override hard-coded statement level hints and existing plan guide hints. 

If a query hint contradicts what is possible for query optimization, the hint will not block query execution and the hint will not be applied. In the cases where a hint would cause a query to fail, the hint is ignored and failure the latest details can be viewed in [sys.query_store_query_hints](../system-catalog-views/sys-query-store-query-hints-transact-sql.md).

## Query Store Hints system stored procedures

To create or update hints, use sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md):

```sql
sp_query_store_set_hints
    @query_id bigint,
    @query_hints nvarchar(max)
```
 
Hints are specified in a valid string format N'OPTION (..)'. 

> [!Note]
> For a complete list of hints that are supported, see [sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md).

* If no Query Store Hint exists for a specific query_id, a new Query Store Hint will be created. 
* If a Query Store Hint already exists for a specific query_id, the last value provided will override previously specified values for the associated query. 
* If a query_id doesn't exist, an error will be raised. 

To remove hints associated with a query_id, use [sys.sp_query_store_clear_hints](../system-stored-procedures/sys-sp-query-store-clear-hints-transact-sql.md):

```sql
sp_query_store_clear_hints 
    @query_id bigint
```

## ShowPlan XML attributes

When hints are applied, the following will be surfaced in the StmtSimple element of the ShowPlan XML:

|Attribute| Description|
|--|--|
|QueryStoreStatementHintText|Actual Query Store hint(s) applied to the query|
|QueryStoreStatementHintId|Unique identifier of a query hint|
|QueryStoreStatementHintSource|Source of Query Store hint (ex: "User")|


## Examples  

### Identify a query_id in Query Store

The following example queries [sys.query_store_query_text](../system-catalog-views/sys-query-store-query-text-transact-sql.md) and [sys.query_store_query](../system-catalog-views/sys-query-store-query-transact-sql.md) to return the query_id for an executed query text fragment:

```sql
SELECT q.query_id, qt.query_sql_text
FROM sys.query_store_query_text qt 
INNER JOIN sys.query_store_query q ON 
    qt.query_text_id = q.query_text_id 
WHERE query_sql_text like N'%ORDER BY ListingPrice DESC%'  
  AND query_sql_text not like N'%query_store%';
GO
```

 Then, apply the hint to force the [legacy cardinality estimator](../performance/cardinality-estimation-sql-server.md) to query_id 39, identified in Query Store:
  
```sql
EXEC sys.sp_query_store_set_hints @query_id= 39, @query_hints = N'OPTION(USE HINT(''FORCE_LEGACY_CARDINALITY_ESTIMATION''))';
```  

 Or, you can apply multiple query hints to query_id 39:

```sql
EXEC sys.sp_query_store_set_hints @query_id= 39, @query_hints = N'OPTION(RECOMPILE, MAXDOP 1, USE HINT(''QUERY_OPTIMIZER_COMPATIBILITY_LEVEL_120''))';
```

 Review the Query Store Hint in place for query_id 39:

```sql
SELECT query_hint_id, query_id, query_hint_text, last_query_hint_failure_reason, last_query_hint_failure_reason_desc, query_hint_failure_count, source, source_desc, comment 
FROM sys.query_store_query_hints 
WHERE query_id = 39;
```

## See also

- [Hints (Transact-SQL) - Query](../../t-sql/queries/hints-transact-sql-query.md)  
- [Best practices with Query Store](best-practice-with-the-query-store.md)
- [Monitor performance by using Query Store](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)
- [sys.query_store_query_hints (Transact-SQL)](../system-catalog-views/sys-query-store-query-hints-transact-sql.md)   
- [sys.sp_query_store_set_hints (Transact-SQL)](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md)   
- [sys.sp_query_store_clear_hints (Transact-SQL)](../system-stored-procedures/sys-sp-query-store-clear-hints-transact-sql.md)   


